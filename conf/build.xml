
<project name="TSTool" default="compile-java" basedir="../">
    <import file="../../rtibuild/common-build.xml"/>
    <import file="../../rtibuild/common-installer.xml"/>
    
    <target name="local-install-CDSS" description="CDSS local install" depends="-init-CDSS,local-install"/>
    
    <target name="local-install-rti" description="rti local install" depends="-init-rti,local-install"/>
    
    <target name="nsis-CDSS" depends="-init,-clean-logs"  description="CDSS nsis installer">
        <nsisinstaller dir="installer/CDSS" nsi="TSTool.nsi"/>
    </target>
    
    <target name="clean-install-CDSS" description="Remove local install CDSS" depends="-init-CDSS,clean-install"/>
    <target name="clean-install-rti" description="Remove local install rti" depends="-init-rti,clean-install"/>
    
    <target name="installer-CDSS" description="CDSS nsis installer" depends="clean-install-CDSS,local-install-CDSS,nsis-CDSS"/>
    
    <target name="nsis-rti" depends="-init,-clean-logs" description="rti nsis installer">
        <nsisinstaller nsi="rivertrack/TSTool.nsi"/>
    </target>
    
    <target name="installer-rti" description="rti nsis installer" depends="clean-install-rti,local-install-rti,nsis-rti"/>
    
    <target name="-clean-logs" description="clean log directories before installer">
        <delete dir="${install.dir}/logs" includes="*"/>
    </target>
    
    <!-- this is called after standard-local-install and allows common resources to be copied in -->
    <target name="-install-local" depends="-install-local-cdss,-install-local-rti,-exe">
        <copy todir="${install.dir}/bin" file="externals/shellcon/shellcon.exe"/>
        <copy todir="${install.dir}/bin" file="scripts/TSTool.bat"/>
        <copy todir="${install.dir}/bin" file="installer/common/TSTool.l4j.ini"/>
    	<mkdir dir="${install.dir}/logs"/>
    </target>
    
    <!-- the following two targets perform initialization of properties -->
    <target name="-init-CDSS" depends="-init">
        <!-- set the installer.cdss property to allow the appropriate post-installer-xxx to run-->
        <property name="installer.cdss" value="true"/>
        <!-- alternatively, properties could be loaded from a file ...
        <property file="installer/CDSS/install.properties"/>
        -->
        <property name="install.dir" value="${dist.dir}/install-CDSS"/>
        <property name="license.file" value="externals/CDSS/system/TSTool.cfg"/>
        <!-- icon is relative to dist directory, since launch4j xml is created there-->
        <property name="tstool.icon" value="../externals/CDSS/graphics/waterMark.ico"/>
    </target>
    
    <target name="-init-rti" depends="-init">
        <property name="installer.rti" value="true"/>
        <property name="install.dir" value="${dist.dir}/install-rti"/>
        <property name="license.file" value="test/operational/RTi/system/TSTool.cfg"/>
        <property name="tstool.icon" value="../externals/Rivertrak/graphics/RTi.ico"/>
    </target>
    
    <target name="cdss-exe" depends="-init-CDSS,-exe" description="a"/>
    
    <target name="-exe" depends="-init-deps" description="create tstool.exe">
        <launch4j-exe exe="TSTool" jreName="142" productIcon="${tstool.icon}" 
            mainClass="DWR.DMI.tstool.tstool">
            <opts>
                <opt>"-Dtstool.home=%EXEDIR%/.."</opt>
            </opts>
        </launch4j-exe>
        <move file="${dist.dir}/TSTool.exe" todir="${install.dir}/bin"/>
    </target>
    
    <!-- the following two targets copy additional resources to local install dirs -->
    <target name="-install-local-cdss" if="installer.cdss">
        <mkdir dir="${install.dir}/doc/UserManual"/>
        <copy todir="${install.dir}/doc/UserManual" file="doc/UserManual/dist_CDSS/TSTool.pdf"/>
        <copy todir="${install.dir}/system">
            <fileset dir="externals/CDSS/system" includes="*"/>
        </copy>
    </target>
    
    <target name="-install-local-rti" if="installer.rti">
        <copy todir="${install.dir}/bin" file="installer/common/TSTool.exe"/>
        <copy todir="${install.dir}/system">
            <fileset dir="externals/Rivertrak/system" includes="*"/>
        </copy>
    </target>
    
</project>
