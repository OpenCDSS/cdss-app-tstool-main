#!/bin/bash
#
# Script to run TSTool on UNIX
# Set the INSTALL_HOME to the main installation folder.
# Set the JAVA_EXE to the "java" program that is the Java Runtime Environment
#
# History (newest at top):
# 2016-05-03 Steve Malers, OWF    Update for TSTool 11.10.01.  Add javax.mail.jar, mysql.
# 2015-04-08 Steve Malers, OWF    Update for TSTool 11.00.00, which uses Java 7 and Git/Eclipse names for jars.
# 2014-04-19 Steve Malers, OWF    Original version of this script to streamline Linux builds.

# Installation home for TSTool, under which will be bin, logs, system, etc.
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
INSTALL_HOME="$SCRIPT_DIR/.."

# Location of Java runtime environment
# Typical Linux install (JRE distributed with TSTool)...
JRE_HOME="$INSTALL_HOME/jre_17"
JAVA_EXE="$JRE_HOME/bin/java"
# Or, use the one on the operating system (must be 1.7+)...
# Use this by default for Mac OS X
if [[ "$(uname)" == "Darwin" ]]
then
    JAVA_EXE="/usr/bin/java"
fi

# ------- Below this should not normally need to edit -------

# Indicate where the JAR files live.
JAR_HOME="$INSTALL_HOME/bin"
# Classpath for TSTool, including all Jar files needed for runtime features
# List core files first for rapid access with less used features later.
# These can be compared with the TSTool Help...About TSTool...Show Software/System Details
# output for the classpath, which is a list of jar files in the "bin" folder under the
# TSTool install.  Manually resort a few to have primary jar files at the top and third-party
# libraries after that.
TSTOOL_CP="\
$JAR_HOME/cdss-app-tstool-main_17.jar:\
$JAR_HOME/cdss-lib-common-java_17.jar:\
$JAR_HOME/cdss-lib-processor-ts-java_17.jar:\
$JAR_HOME/cdss-lib-cdss-java_17.jar:\
$JAR_HOME/cdss-lib-dmi-hydrobase-java_17.jar:\
$JAR_HOME/cdss-lib-models-java_17.jar:\
$JAR_HOME/cdss-lib-dmi-nwsrfs-java_17.jar:\
$JAR_HOME/cdss-lib-dmi-riversidedb-java_17.jar:\
$JAR_HOME/cdss-lib-dmi-satmonsys-java_17.jar:\
$JAR_HOME/batik-awt-util.jar:\
$JAR_HOME/batik-dom.jar:\
$JAR_HOME/batik-ext.jar:\
$JAR_HOME/batik-svggen.jar:\
$JAR_HOME/batik-util.jar:\
$JAR_HOME/batik-xml.jar:\
$JAR_HOME/Blowfish_142.jar:\
$JAR_HOME/com.noelios.restlet.jar:\
$JAR_HOME/commons-codec-1.5.jar:\
$JAR_HOME/commons-logging-1.1.jar:\
$JAR_HOME/commons-math3-3.0.jar:\
$JAR_HOME/commons-net-3.3.jar:\
$JAR_HOME/dom4j-1.6.1.jar:\
$JAR_HOME/freemarker.jar:\
$JAR_HOME/gson-2.2.1.jar:\
$JAR_HOME/h2.jar:\
$JAR_HOME/hec.jar:\
$JAR_HOME/heclib.jar:\
$JAR_HOME/jakarta-oro-2.0.8.jar:\
$JAR_HOME/javax.mail.jar:\
$JAR_HOME/jcommon.jar:\
$JAR_HOME/jfreechart.jar:\
$JAR_HOME/jython.jar:\
$JAR_HOME/log4j-1.2.13.jar:\
$JAR_HOME/mysql-connector-java-5.1.36-bin.jar:\
$JAR_HOME/ojdbc6.jar:\
$JAR_HOME/org.restlet.jar:\
$JAR_HOME/poi-3.9-20121203.jar:\
$JAR_HOME/poi-ooxml-3.9-20121203.jar:\
$JAR_HOME/poi-ooxml-schemas-3.9-20121203.jar:\
$JAR_HOME/postgresql-9.3-1102.jdbc4.jar:\
$JAR_HOME/rma.jar:\
$JAR_HOME/sqljdbc4.jar:\
$JAR_HOME/stax-api-1.0.1.jar:\
$JAR_HOME/xerces.jar:\
$JAR_HOME/xmlbeans-2.3.0.jar:\
"

# Make sure the line above this is a double quote
# This allows processing of the Linux distribution

# If TSTool is running out of memory, increase the -Xmx option below
# (maximum megabytes of memory allowed for TSTool).  This seems to go up to 
# about 1200mx maximum on 32bit operating systems.
# On the other hand, if an error is being shown that the Java virtual machine can't start,
# may need to reduce the value because Java 7 takes up more memory.
#
# If graphics misbehave, try using the following:
#  -Dsun.java2d.noddraw=true
#
# If http traffic is routed through a proxy, use the following to use the
# system proxy settings automatically so that web services work
# (actually this is an OK default):
#  -Djava.net.useSystemProxies=true
#
# If running in headless mode, the following may be needed (see http://www.jfree.org/phpBB2/viewtopic.php?t=1012):
#  -Djava.awt.headless=true
#
# The above will interfere with GUI mode so a separate batch file may be needed.
#
JAVA_COMMAND="$JAVA_EXE -Xmx1024m -Djava.net.useSystemProxies=true"

# Checks to confirm the configuration...
# Verify that the installation folder exists
if [ ! -d "$INSTALL_HOME" ]
    then
    echo ""
    echo "Configured INSTALL_HOME=$INSTALL_HOME folder does not exist."
    echo ""
    exit 1
fi
# Verify that an expected software file exists
if [ ! -e "$INSTALL_HOME/bin/cdss-app-tstool-main_17.jar" ]
    then
    echo ""
    echo "Configured INSTALL_HOME=$INSTALL_HOME does not seem correct."
    echo "Unable to find bin/cdss-app-tstool-main_17.jar in this folder."
    echo ""
    exit 1
fi

# Run TSTool, passing up to 9 command line parameters.
command="$JAVA_COMMAND -classpath $TSTOOL_CP rti.app.tstool.TSTool -home $INSTALL_HOME $1 $2 $3 $4 $5 $6 $7 $8 $9"
# Uncomment for troubleshooting...
# echo $command
# Run it...
$command
