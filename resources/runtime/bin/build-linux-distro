#!/bin/bash
#
# Build the Linux distribution for TSTool.
# This script was developed for Ubuntu
#
# History:
# 2015-04-08 Steve Malers, OWF    Update for TSTool 11.00.00, which uses Java 7 and Git/Eclipse names for jars.
# 2014-04-19 Steve Malers, OWF    Original version of this script to streamline Linux builds.
#
# Usage: see usage()
#
# The script typically is run on a Linux computer that has access
# to a Windows installation of TSTool, for example a Linux virtual
# machine running in VirtualBox that has access to the TSTool installation
# via a shared folder.
#
# The script performs the following steps:
#
# 1) Copy all the files from WindowsTSToolInstallFolder to the current directory.
# 2) Remove the Windows JRE and replace with the contents of JREInstallFolder.
# 3) Update the bin/tstool script:
#    - make sure it adds all current java files to the CLASSPATH
#    - make sure that the JRE uses the one from step 2
# 4) Create a tar.gz file that can be distributed
#

function usage () {
	echo ""
	echo "Usage: build-linux-distro -w WindowsTSToolInstallFolder -j JREInstallFolder -z Distro.tar.gz"
	echo ""
	echo "WindowsTSToolInstallFolder = path to the TSTool install folder"
	echo "JREInstallFolder = path to the JRE install folder"
	echo "Distro.tar.gz = tar.gz file to create (specify .tar.gz to avoid confusion)"
	echo ""
	exit 0
}

# Default values
windowsTstoolInstallFolder=""
jreFolder=""
zipFile="TSTool-Linux.tar.gz"
# Whether to copy the files (can be slow)
doCopy="yes"

while getopts "hj:nw:z:" opt
do
	case "$opt" in
		h) usage;;
		j) jreFolder="$OPTARG";;
		n) doCopy="no";;
		w) windowsTstoolInstallFolder="$OPTARG";;
		z) zipFile="$OPTARG";;
		\?) usage;;
	esac
done

echo ""
echo "Original TSTool files are in folder: $windowsTstoolInstallFolder"
echo "JRE files are in folder: $jreFolder"
echo "TSTool distribution file (tar gz) is: $zipFile"
echo ""

if [ -z "$windowsTstoolInstallFolder" ]
	then
	usage
fi
if [ -z "$jreFolder" ]
	then
	usage
fi

# Make sure input exists

if [ ! -d "$windowsTstoolInstallFolder" ]
	then
	echo "" 1>&2
	echo "Original TSTool installation $windowsTstoolInstallFolder does not exist" 1>&2
	usage
fi

if [ ! -d "$jreFolder" ]
	then
	echo "" 1>&2
	echo "JRE installation $jreFolder does not exist" 1>&2
	usage
fi

# Build folder is the same as the Windows folder but without the leading path

buildFolder=$(basename "$windowsTstoolInstallFolder")
echo "Build folder:  $buildFolder"
jreFolderBasename=$(basename "$jreFolder")

# Make sure the build folder is not the same as the original

if [ "$windowsTstoolInstallFolder" == "$buildFolder" ]
	then
	echo "" 1>&2
	echo "Original TSTool folder $windowsTstoolInstallFolder and output build folder are the same" 1>&2
fi

# Copy the files from the original install to the build folder

if [ "$doCopy" == "yes" ]
	then
	if [ -d "$buildFolder" ]
		then
		# Remove local copy of the distribution folder
		# Let the script prompt to protect against accidents (can make silent later)
		echo "Removing files from old build in $buildFolder"
		rm -rI "$buildFolder"
	fi
	echo "Copying files from $windowsTstoolInstallFolder to $buildFolder"
	cp -r "$windowsTstoolInstallFolder" "$buildFolder"
fi

# Remove files don't need to be distributed with Linux
# This could be put in the above if statement but leave here during development

echo "Removing Windows files that don't need to be included in Linux distribution..."
#echo "${buildFolder}/Uninstall_${buildFolder}.exe"
rm -f "${buildFolder}/Uninstall_${buildFolder}.exe"
rm -f "${buildFolder}/bin/DFORMDD.DLL"
rm -f "${buildFolder}/bin/rmaUtil.dll"
rm -f "${buildFolder}/bin/TSTool.bat"
rm -f "${buildFolder}/bin/TSTool.exe"
rm -f "${buildFolder}/bin/TSTool.l4j.ini"
rm -f ${buildFolder}/logs/*.log

# The sequence of "tstool" script verions is:
# tstool - original that is distributed with the software
# tstool2 - location of JRE
# tstool3 - original script without jar classpath lines
# tstool4 - tstool3 without the single quote at the end of the classpath
# tstool5 - tstool4 with the main jar files added to the classpath 
# tstool6 - tstool5 with the third-party jar files added to the classpath 
# tstool - copy tstool6 onto the original tstool

# Replace the old JRE with the specified one

echo "Removing Windows JRE..."
rm -rf ${buildFolder}/jre*

echo "Copying Linux JRE ${jreFolder} to distribution folder ${buildFolder}"
cp -rp ${jreFolder} ${buildFolder}

# Update the tstool script to have the specified JRE
# TODO SAM 2013-11-13
# Figure out this better later.  For now know that jre_17 is in file
#sed "s/JAVA_HOME=.*$/JAVA_HOME=\"\$INSTALL_HOME\/${jreFolderBasename}\"/g" ${buildFolder}/bin/tstool > ${buildFolder}/bin/tstool2
sed "s/jre_17/${jreFolderBasename}/g" ${buildFolder}/bin/tstool > tstool2

# Remove lines with jar:, which are the classpath lines
sed "/jar:/d" tstool2 > tstool3
# Remove the single double quote indicating end of classpath with placeholders to replace
sed "s/^\"$/STANDARD_JARS\nOTHER_JARS\n\"/g" tstool3 > tstool4

# Next insert all remaining jar files but exclude the _16 and _142 files that are the main ones included above
# insert1 - the text to insert in the classpath with main jar files (deals with escaping characters so sed can handle)
# insert2 - the text to insert in the classpath with othe jar files (deals with escaping characters so sed can handle)
# junk1 - list of jar files in the TSTool bin folder, sorted alphabetically (from "ls")
# junk2 - list of jar files minus those with _17 (the jars from TSTool code)
# junk3 - list of jar files minus those with _17 and _142 (add the Blowfish library used for encryption for RiversideDB)
# junk4 - replace leading part of path in junk3 with $JAR_HOME (but still has /bin in path)
# junk5 - remove /bin from path from junk4 since $JAR_HOME includes
# junk6 - the classpath for third-party jars, with forward slashes escaped for sed insert
# junk7 - the classpath for third-party jars, with escaping of continuation character at end for sed insert
# junk8 - the classpath for third-party jars (same as insert2)

# Now insert the desired content.  For now hard-code the main TSTool tar files at the top of the classpath
insert1='$JAR_HOME\/cdss-app-tstool-main_17.jar:\\\n$JAR_HOME\/cdss-lib-common-java_17.jar:\\\n$JAR_HOME\/cdss-lib-processor-ts-java_17.jar:\\\n$JAR_HOME\/cdss-lib-cdss-java_17.jar:\\\n$JAR_HOME\/cdss-lib-dmi-hydrobase-java_17.jar:\\\n$JAR_HOME\/cdss-lib-models-java_17.jar:\\\n$JAR_HOME\/cdss-lib-dmi-nwsrfs-java_17.jar:\\\n$JAR_HOME\/cdss-lib-dmi-riversidedb-java_17.jar:\\\n$JAR_HOME\/cdss-lib-dmi-satmonsys-java_17.jar:\\\n$JAR_HOME\/Blowfish_142.jar:\\'
echo $insert1
echo $insert1 > insert1
sed s/STANDARD_JARS/"$insert1"/g tstool4 > tstool5

ls ${buildFolder}/bin/*jar > junk1
sed '/_17/d' junk1 > junk2
sed '/_142/d' junk2 > junk3
# Remove specific version with generic string
sed s/"$buildFolder"/\$JAR_HOME/g junk3 > junk4
# Replace "/bin" since not needed
sed 's/\/bin//g' junk4 > junk5
# Escape forward slashes
sed 's/\//\\\//g' junk5 > junk6
# Escape string at end
sed 's/$/:\\\\/g' junk6 > junk7
# Replace newline with representation that can be handed to sed
sed -e :a -e N -e 's/\n/\\n/' -e ta junk7 > junk8
insert2=$(cat junk8)
echo $insert2 > insert2
sed s/OTHER_JARS/"$insert2"/g tstool5 > tstool6

# Replace the original tstool file with the new version, in the distribution
cp -f tstool6 $buildFolder/bin/tstool
chmod a+x $buildFolder/bin/tstool

# Make sure the log folder is writeable
chmod a+w $buildFolder/logs

# Make sure directories are executable
chmod -R +rX $buildFolder

# Cleanup (comment out if troubleshooting this script)
rm junk* insert* tstool*

# Compress the install

tar -czvf $zipFile $buildFolder

# Exit script

exit 0
